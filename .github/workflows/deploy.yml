name: Deploy

on:
  push:
    branches:
      - docker-dev
  workflow_dispatch:

env:
  SSH_HOST: ${{ secrets.SSH_HOST }}
  SSH_PORT: ${{ secrets.SSH_PORT }}
  SSH_USER: ${{ secrets.SSH_USER }}
  SSH_KEY: ${{ secrets.SSH_KEY }}
  CONFIG_ENV: ${{ secrets.CONFIG_ENV }}
  PORT: ${{ secrets.PORT }}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install

      - name: Build
        run: npm run build

      - name: Create TAR artifact
        run: tar -czf dist.tar.gz dist

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: pesantren-be-dist
          path: dist.tar.gz
          retention-days: 7

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: true

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: pesantren-be-dist
          path: .

      - name: Prepare env file
        run: |
          printf "%s" "${CONFIG_ENV}" > .env
      - name: Set default deploy dir
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          echo "APP_NAME=${REPO_NAME}" >> $GITHUB_ENV
          if [ -z "${DEPLOY_DIR}" ]; then
            echo "DEPLOY_DIR=/home/apps/${APP_NAME:-$REPO_NAME}" >> $GITHUB_ENV
          fi

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.SSH_HOST }}
          port: ${{ env.SSH_PORT }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          source: ".env,docker-compose.yml,dist.tar.gz"
          target: "/home/apps/${{ github.event.repository.name }}"
          overwrite: true

      - name: Deploy on server
        uses: appleboy/ssh-action@v1.0.3
        env:
          APP_NAME: ${{ env.APP_NAME }}
          DEPLOY_DIR: ${{ env.DEPLOY_DIR }}
          PORT: ${{ env.PORT }}
        with:
          host: ${{ env.SSH_HOST }}
          port: ${{ env.SSH_PORT }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          envs: APP_NAME,DEPLOY_DIR,PORT
          script_stop: true
          script: |
            set -e
            DEPLOY_DIR=${DEPLOY_DIR:-/home/apps/${APP_NAME}}
            mkdir -p "$DEPLOY_DIR"
            cd "$DEPLOY_DIR"
            timestamp=$(date +%Y%m%d%H%M%S)
            mkdir -p backups
            if [ -f docker-compose.yml ]; then cp -f docker-compose.yml "backups/docker-compose.yml.$timestamp"; fi
            if [ -d dist ]; then tar -czf "backups/dist.$timestamp.tar.gz" dist; fi
            rm -rf dist
            tar -xzf dist.tar.gz
            if docker compose version >/dev/null 2>&1; then
              DCMD="docker compose"
            else
              DCMD="docker-compose"
            fi
            $DCMD down
            $DCMD up -d
            set +e
            ok=0
            attempts=0
            port=${PORT:-5000}
            until [ $attempts -ge 10 ]; do
              if curl -fsS "http://localhost:${port}/health" >/dev/null 2>&1; then
                ok=1
                break
              fi
              attempts=$((attempts+1))
              sleep 5
            done
            set -e
            if [ "$ok" -ne 1 ]; then
              $DCMD down
              rm -rf dist
              if [ -f "backups/dist.$timestamp.tar.gz" ]; then tar -xzf "backups/dist.$timestamp.tar.gz"; fi
              if [ -f "backups/docker-compose.yml.$timestamp" ]; then cp -f "backups/docker-compose.yml.$timestamp" docker-compose.yml; fi
              $DCMD up -d
              exit 1
            fi
            docker ps --format '{{.Names}} {{.Status}}'
