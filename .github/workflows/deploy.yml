name: Deploy

on:
  push:
    branches:
      - docker-dev
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install

      - name: Build
        run: npm run build

      - name: Install RAR
        run: |
          sudo apt-get update
          sudo apt-get install -y rar

      - name: Create RAR artifact
        run: rar a pesantren-be-dist.rar dist

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: pesantren-be-dist
          path: pesantren-be-dist.rar
          retention-days: 7

  deploy:
    needs: build
    runs-on: ubuntu-latest
    env:
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_PORT: ${{ secrets.SSH_PORT }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_KEY: ${{ secrets.SSH_KEY }}
      SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
      DEPLOY_DIR: ${{ secrets.DEPLOY_DIR }}
      APP_NAME: ${{ secrets.APP_NAME }}
      CONFIG_ENV: ${{ secrets.CONFIG_ENV }}
      PORT: ${{ secrets.PORT }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: true

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: pesantren-be-dist
          path: .

      - name: Prepare env file
        run: |
          printf "%s" "${CONFIG_ENV}" > .env
      - name: Set default deploy dir
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          if [ -z "${APP_NAME}" ]; then
            echo "APP_NAME=${REPO_NAME}" >> $GITHUB_ENV
          fi
          if [ -z "${DEPLOY_DIR}" ]; then
            echo "DEPLOY_DIR=/home/apps/${APP_NAME:-$REPO_NAME}" >> $GITHUB_ENV
          fi

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.SSH_HOST }}
          port: ${{ env.SSH_PORT }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          password: ${{ env.SSH_PASSWORD }}
          source: ".env,docker-compose.yml,pesantren-be-dist.rar"
          target: "${{ env.DEPLOY_DIR }}"
          overwrite: true

      - name: Deploy on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SSH_HOST }}
          port: ${{ env.SSH_PORT }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          password: ${{ env.SSH_PASSWORD }}
          script_stop: true
          script: |
            set -e
            DEPLOY_DIR=${DEPLOY_DIR:-/home/apps/${APP_NAME}}
            mkdir -p "$DEPLOY_DIR"
            cd "$DEPLOY_DIR"
            timestamp=$(date +%Y%m%d%H%M%S)
            mkdir -p backups
            if [ -f docker-compose.yml ]; then cp -f docker-compose.yml "backups/docker-compose.yml.$timestamp"; fi
            if [ -d dist ]; then tar -czf "backups/dist.$timestamp.tar.gz" dist; fi
            if ! command -v unrar >/dev/null 2>&1; then
              if command -v apt-get >/dev/null 2>&1; then
                sudo apt-get update && sudo apt-get install -y unrar
              elif command -v apk >/dev/null 2>&1; then
                sudo apk add --no-cache unrar
              elif command -v yum >/dev/null 2>&1; then
                sudo yum install -y unrar
              fi
            fi
            rm -rf dist
            unrar x -o+ pesantren-be-dist.rar
            if docker compose version >/dev/null 2>&1; then
              DCMD="docker compose"
            else
              DCMD="docker-compose"
            fi
            $DCMD down
            $DCMD up -d
            set +e
            ok=0
            attempts=0
            port=${PORT:-5000}
            until [ $attempts -ge 10 ]; do
              if curl -fsS "http://localhost:${port}/health" >/dev/null 2>&1; then
                ok=1
                break
              fi
              attempts=$((attempts+1))
              sleep 5
            done
            set -e
            if [ "$ok" -ne 1 ]; then
              $DCMD down
              rm -rf dist
              if [ -f "backups/dist.$timestamp.tar.gz" ]; then tar -xzf "backups/dist.$timestamp.tar.gz"; fi
              if [ -f "backups/docker-compose.yml.$timestamp" ]; then cp -f "backups/docker-compose.yml.$timestamp" docker-compose.yml; fi
              $DCMD up -d
              exit 1
            fi
            docker ps --format '{{.Names}} {{.Status}}'
